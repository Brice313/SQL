--FR v3
SELECT 
	COUNT(shipment_id) AS Volume
	, carrier_name
	, ship_method
	, CAST(EXTRACT(YEAR FROM processing_date+1) AS char(4))+'-'+RIGHT('0'+ CAST(EXTRACT(WEEK FROM processing_date+1) AS char(2)),2) as week_number
	, AVG(ship_cost) AS avg_shipcost
	, ship_cost_uom
	, AVG(ranking_cost) AS avg_rankingcost
	, ranking_cost_uom
FROM
	atrops_eu.o_slam_packages
WHERE
	shipment_id IN (SELECT 
							sp.shipment_id
					FROM
							atrops_eu.o_slam_packages AS sp
							JOIN 
							( SELECT 
									shipment_id
									, CASE WHEN (length>=width AND length>=height) THEN length
										   WHEN (width>=length AND width>=height) THEN width
										   WHEN (height>=width AND height>=length) THEN height
									  		END AS true_length
									, CASE WHEN (length>=width AND length>=height) THEN width
										   WHEN (width>=length AND width>=height) THEN length
										   WHEN (height>=width AND height>=length) THEN length
									  		END AS true_h_w
									, CASE WHEN (length>=width AND length>=height) THEN height
										   WHEN (width>=length AND width>=height) THEN height
										   WHEN (height>=width AND height>=length) THEN width
									  	  	END AS true_w_h
						 		FROM
						 			atrops_eu.o_slam_packages
						 	) AS temp ON temp.shipment_id=sp.shipment_id
					WHERE
							--time period-------------------------------------------------------------------------
							processing_date BETWEEN '2017-09-06' AND '2018-09-06'
							--size restriction -------------------------------------------------------------------
							AND true_length <= CASE WHEN length_uom= 'IN' THEN  150 * 2.54
												    ELSE 150
										       END
							AND true_w_h <= CASE WHEN length_uom= 'IN' THEN  75 * 2.54
												 ELSE 75
											END
							AND true_h_w <= CASE WHEN length_uom= 'IN' THEN  75 * 2.54
												ELSE 75
											END
							AND (true_length > 120 OR true_w_h > 60 OR true_h_w > 60)
							--girth restriction-------------------------------------------------------------------
							AND 360 >= CASE WHEN length_uom= 'IN' THEN true_length * 2.54 + 2 * (true_w_h *2.54 + true_h_w * 2.54)
											ELSE true_length + 2 * (true_w_h + true_h_w)
						           	   END
							--weight restriction ------------------------------------------------------------------
							AND scale_weight <= CASE WHEN scale_weight_uom= 'grams' THEN  20 * 1000
													 WHEN scale_weight_uom= 'pounds' THEN  20 * 2.20462
													 ELSE 20
												END
							--FC connection and jurisdiction-------------------------------------------------------
							AND destination_country_code='FR'
							AND warehouse_id IN ('POZ1',	'MXP5',	'MXP3',	'WRO1',	'WRO2',	'HAM2',	'FCO1',	'MAN3',	'MAN2',	'MAN1',	'GLA1',	'LCY2',	'XESA',	'LTN4',	'LTN2',	'BCN3',	'LTN1',	'BER3',	'BCN1',	'XESC',	'MRS1',	'LIL1',	'BHX1',	'BHX2',	'BHX3',	'XDEI',	'XDEJ',	'DTM1',	'XDEH',	'XDET',	'XUKD',	'DUS2',	'ORY1',	'LYS1',	'XITC',	'CGN1',	'XFRE',	'XITD',	'XFRF',	'XFRG',	'XDEU',	'LBA1',	'LBA2',	'XUKK',	'MAD4',	'MUC3',	'EUK5',	'EDE4',	'SZZ1',	'BVA1',	'EDI4',	'STR1',	'KTW1',	'LEJ1',	'FRA7',	'FRA1',	'FRA3',	'PRG2',	'CWL1')
							AND destination_postal_code IN ('06000',	'06100',	'06110',	'06130',	'06150',	'06160',	'06200',	'06210',	'06220',	'06230',	'06250',	'06300',	'06310',	'06340',	'06360',	'06370',	'06400',	'06550',	'06560',	'06570',	'06580',	'06600',	'06610',	'06700',	'06730',	'06800',	'06950',	'11100',	'11110',	'11120',	'11590',	'13001',	'13002',	'13003',	'13004',	'13005',	'13006',	'13007',	'13008',	'13009',	'13010',	'13011',	'13012',	'13013',	'13014',	'13015',	'13016',	'13080',	'13090',	'13100',	'13105',	'13109',	'13110',	'13111',	'13112',	'13113',	'13116',	'13117',	'13119',	'13120',	'13121',	'13122',	'13124',	'13127',	'13130',	'13140',	'13170',	'13180',	'13190',	'13220',	'13240',	'13250',	'13260',	'13290',	'13300',	'13320',	'13330',	'13340',	'13350',	'13360',	'13370',	'13380',	'13390',	'13400',	'13410',	'13420',	'13450',	'13470',	'13480',	'13500',	'13510',	'13530',	'13540',	'13580',	'13590',	'13600',	'13610',	'13620',	'13640',	'13680',	'13700',	'13710',	'13720',	'13730',	'13740',	'13760',	'13770',	'13790',	'13800',	'13820',	'13821',	'13830',	'13840',	'13850',	'13880',	'13920',	'13950',	'13960',	'13980',	'30000',	'30111',	'30114',	'30121',	'30127',	'30128',	'30129',	'30132',	'30230',	'30310',	'30320',	'30420',	'30510',	'30540',	'30620',	'30660',	'30670',	'30820',	'30870',	'30900',	'30920',	'30980',	'31000',	'31100',	'31120',	'31130',	'31140',	'31150',	'31170',	'31180',	'31190',	'31200',	'31240',	'31270',	'31280',	'31300',	'31320',	'31330',	'31340',	'31380',	'31390',	'31400',	'31410',	'31450',	'31470',	'31490',	'31500',	'31520',	'31530',	'31570',	'31590',	'31600',	'31620',	'31650',	'31660',	'31670',	'31700',	'31750',	'31770',	'31780',	'31790',	'31810',	'31820',	'31830',	'31840',	'31850',	'31860',	'31870',	'31880',	'32600',	'34000',	'34070',	'34080',	'34090',	'34170',	'34250',	'34300',	'34310',	'34350',	'34370',	'34410',	'34420',	'34430',	'34440',	'34450',	'34470',	'34500',	'34550',	'34620',	'34670',	'34680',	'34710',	'34740',	'34760',	'34790',	'34830',	'34880',	'34920',	'34970',	'34990',	'51100',	'51350',	'51370',	'51430',	'51450',	'54000',	'54100',	'54110',	'54130',	'54136',	'54140',	'54180',	'54210',	'54220',	'54230',	'54250',	'54270',	'54320',	'54340',	'54390',	'54410',	'54420',	'54425',	'54460',	'54500',	'54510',	'54520',	'54600',	'54630',	'54670',	'54690',	'54710',	'54840',	'54850',	'57000',	'57050',	'57070',	'57120',	'57140',	'57175',	'57280',	'57300',	'57360',	'57365',	'57525',	'57535',	'57950',	'59000',	'59100',	'59110',	'59112',	'59113',	'59115',	'59116',	'59117',	'59118',	'59119',	'59120',	'59121',	'59123',	'59124',	'59125',	'59126',	'59128',	'59130',	'59133',	'59134',	'59135',	'59136',	'59139',	'59140',	'59146',	'59147',	'59148',	'59150',	'59152',	'59153',	'59154',	'59155',	'59156',	'59158',	'59160',	'59162',	'59163',	'59165',	'59166',	'59167',	'59170',	'59171',	'59174',	'59175',	'59176',	'59178',	'59179',	'59180',	'59181',	'59182',	'59184',	'59185',	'59187',	'59190',	'59192',	'59193',	'59194',	'59195',	'59199',	'59200',	'59210',	'59211',	'59215',	'59220',	'59221',	'59223',	'59224',	'59226',	'59229',	'59230',	'59232',	'59233',	'59234',	'59235',	'59236',	'59237',	'59239',	'59240',	'59242',	'59243',	'59246',	'59249',	'59250',	'59251',	'59253',	'59254',	'59255',	'59260',	'59261',	'59262',	'59263',	'59264',	'59269',	'59270',	'59272',	'59273',	'59274',	'59278',	'59279',	'59280',	'59282',	'59283',	'59286',	'59290',	'59293',	'59299',	'59300',	'59310',	'59320',	'59350',	'59370',	'59390',	'59410',	'59420',	'59430',	'59450',	'59480',	'59490',	'59491',	'59492',	'59493',	'59494',	'59495',	'59496',	'59500',	'59510',	'59520',	'59551',	'59552',	'59553',	'59560',	'59580',	'59590',	'59640',	'59650',	'59660',	'59690',	'59700',	'59710',	'59760',	'59770',	'59777',	'59780',	'59790',	'59800',	'59810',	'59820',	'59830',	'59840',	'59850',	'59860',	'59870',	'59880',	'59890',	'59910',	'59920',	'59930',	'59940',	'59950',	'59960',	'59970',	'59990',	'62000',	'62110',	'62113',	'62114',	'62119',	'62122',	'62131',	'62136',	'62138',	'62141',	'62143',	'62144',	'62149',	'62151',	'62153',	'62157',	'62160',	'62161',	'62172',	'62190',	'62196',	'62199',	'62210',	'62217',	'62218',	'62220',	'62221',	'62223',	'62232',	'62260',	'62290',	'62300',	'62320',	'62330',	'62350',	'62400',	'62410',	'62420',	'62430',	'62440',	'62470',	'62530',	'62540',	'62580',	'62590',	'62620',	'62640',	'62660',	'62670',	'62680',	'62700',	'62710',	'62740',	'62750',	'62790',	'62800',	'62820',	'62840',	'62880',	'62920',	'62940',	'62950',	'62970',	'62980',	'64000',	'64110',	'64140',	'64320',	'64420',	'64510',	'65000',	'65290',	'65310',	'65360',	'65390',	'65430',	'65460',	'65600',	'65690',	'65800',	'66000',	'66100',	'66140',	'66180',	'66200',	'66240',	'66250',	'66270',	'66280',	'66330',	'66350',	'66380',	'66410',	'66420',	'66430',	'66440',	'66450',	'66470',	'66530',	'66540',	'66570',	'66610',	'66670',	'66680',	'66750',	'67000',	'67100',	'67112',	'67113',	'67114',	'67115',	'67116',	'67117',	'67118',	'67120',	'67140',	'67150',	'67170',	'67190',	'67200',	'67201',	'67202',	'67203',	'67204',	'67205',	'67206',	'67207',	'67210',	'67230',	'67240',	'67270',	'67300',	'67310',	'67350',	'67370',	'67380',	'67390',	'67400',	'67410',	'67450',	'67460',	'67470',	'67480',	'67500',	'67520',	'67540',	'67550',	'67560',	'67590',	'67600',	'67610',	'67620',	'67630',	'67640',	'67670',	'67680',	'67720',	'67760',	'67770',	'67800',	'67810',	'67820',	'67840',	'67850',	'67860',	'67870',	'67880',	'67920',	'67930',	'67960',	'67980',	'67990',	'68000',	'68040',	'68100',	'68110',	'68116',	'68120',	'68124',	'68125',	'68127',	'68128',	'68130',	'68170',	'68180',	'68190',	'68200',	'68230',	'68250',	'68260',	'68270',	'68280',	'68300',	'68310',	'68320',	'68330',	'68350',	'68360',	'68390',	'68400',	'68420',	'68440',	'68460',	'68490',	'68500',	'68510',	'68520',	'68530',	'68540',	'68570',	'68600',	'68680',	'68700',	'68720',	'68730',	'68740',	'68770',	'68790',	'68800',	'68840',	'68850',	'68870',	'68890',	'68920',	'68950',	'68990',	'75001',	'75002',	'75003',	'75004',	'75005',	'75006',	'75007',	'75008',	'75009',	'75010',	'75011',	'75012',	'75013',	'75014',	'75015',	'75016',	'75017',	'75018',	'75019',	'75020',	'75116',	'77090',	'77127',	'77135',	'77150',	'77164',	'77166',	'77170',	'77173',	'77177',	'77181',	'77183',	'77184',	'77185',	'77186',	'77200',	'77230',	'77270',	'77280',	'77290',	'77330',	'77340',	'77360',	'77380',	'77400',	'77410',	'77420',	'77450',	'77500',	'77600',	'77680',	'77990',	'78140',	'80000',	'80080',	'80090',	'80115',	'80136',	'80330',	'80440',	'80450',	'80470',	'80480',	'80800',	'81000',	'81130',	'81150',	'81160',	'81370',	'81380',	'81400',	'81450',	'81600',	'81990',	'82000',	'82100',	'82170',	'82290',	'82350',	'82370',	'82410',	'82700',	'82710',	'83000',	'83100',	'83110',	'83130',	'83140',	'83150',	'83160',	'83190',	'83200',	'83210',	'83220',	'83260',	'83270',	'83320',	'83330',	'83390',	'83430',	'83500',	'83640',	'83740',	'84530',	'91260',	'91270',	'91280',	'91300',	'91320',	'91330',	'91350',	'91360',	'91370',	'91380',	'91390',	'91420',	'91430',	'91450',	'91480',	'91550',	'91560',	'91600',	'91700',	'91800',	'91860',	'92100',	'92110',	'92120',	'92130',	'92140',	'92150',	'92160',	'92170',	'92190',	'92200',	'92220',	'92230',	'92240',	'92250',	'92260',	'92270',	'92290',	'92300',	'92310',	'92320',	'92330',	'92340',	'92350',	'92360',	'92390',	'92400',	'92600',	'92700',	'92800',	'93000',	'93100',	'93110',	'93120',	'93130',	'91000',	'91070',	'91080',	'91100',	'91120',	'91130',	'91160',	'91170',	'91200',	'91210',	'91230',	'91240',	'91250',	'93140',	'93150',	'93160',	'93170',	'93190',	'93200',	'93210',	'93220',	'93230',	'93240',	'93250',	'93260',	'93270',	'93290',	'93300',	'93310',	'93320',	'93330',	'93340',	'93350',	'93360',	'93370',	'93380',	'93390',	'93400',	'93410',	'93420',	'93430',	'93440',	'93450',	'93460',	'93470',	'93500',	'93600',	'93700',	'93800',	'94000',	'94100',	'94110',	'94120',	'94130',	'94140',	'94150',	'94160',	'94170',	'94190',	'94200',	'94210',	'94220',	'94230',	'94240',	'94250',	'94260',	'94270',	'94290',	'94300',	'94310',	'94320',	'94340',	'94350',	'94360',	'94370',	'94380',	'94390',	'94400',	'94410',	'94420',	'94430',	'94440',	'94450',	'94460',	'94470',	'94480',	'94490',	'94500',	'94510',	'94520',	'94550',	'94600',	'94700',	'94800',	'94880',	'95140',	'95160',	'95170',	'95190',	'95200',	'95270',	'95330',	'95350',	'95360',	'95380',	'95400',	'95410',	'95440',	'95460',	'95470',	'95500',	'95560',	'95570',	'95670',	'95700',	'95720',	'95850',	'64230',	'01700',	'38000',	'38070',	'38090',	'38120',	'38130',	'38170',	'38180',	'38200',	'38230',	'38240',	'38280',	'38290',	'38330',	'38340',	'38360',	'38400',	'38540',	'38600',	'38610',	'38670',	'38700',	'38780',	'38790',	'38950',	'42000',	'42100',	'42150',	'42152',	'42230',	'42270',	'42290',	'42350',	'42390',	'42400',	'42490',	'42500',	'42530',	'42580',	'42650',	'42700',	'69001',	'69002',	'69003',	'69004',	'69005',	'69006',	'69007',	'69008',	'69009',	'69100',	'69110',	'69120',	'69124',	'69125',	'69126',	'69130',	'69140',	'69150',	'69160',	'69190',	'69200',	'69230',	'69250',	'69260',	'69270',	'69280',	'69290',	'69300',	'69310',	'69320',	'69330',	'69340',	'69350',	'69360',	'69370',	'69390',	'69410',	'69450',	'69500',	'69520',	'69530',	'69540',	'69570',	'69580',	'69600',	'69630',	'69660',	'69680',	'69720',	'69730',	'69740',	'69760',	'69780',	'69800',	'69890',	'69960',	'69970',	'74000',	'74330',	'74370',	'74600',	'74650',	'74940',	'74960',	'38118',	'01800',	'01360',	'69380',	'38300',	'01390',	'69560',	'69420',	'69440',	'38080',	'74910',	'74320',	'74150',	'74930',	'74520',	'74160',	'74540',	'74350',	'74560',	'74570',	'74580',	'74410',	'74270',	'74800',	'74290',	'38760',	'38113',	'38410',	'38420',	'38800',	'38430',	'38850',	'38450',	'38470',	'38140',	'38500',	'38960',	'38160',	'38560',	'38210',	'38590',	'38640',	'38320',	'38690',	'42680',	'42320',	'42140',	'42330',	'42340',	'42570',	'42160',	'43330',	'42800',	'42170',	'42610',	'42210',	'42450',	'42240',	'43110',	'42480',	'43240',	'01120',	'38110',	'38390',	'69480',	'01150',	'69510',	'38121',	'38440',	'38460',	'69650',	'69210',	'69670',	'01600',	'69700',	'13160',	'13440',	'13550',	'13570',	'13630',	'13670',	'13690',	'13750',	'13870',	'13910',	'13940',	'30131',	'30133',	'30400',	'84000',	'84130',	'84140',	'84170',	'84210',	'84250',	'84270',	'84310',	'84320',	'84450',	'84470',	'84510',	'84700',	'84740',	'84800',	'91250',	'91310',	'91620',	'75007',	'75015',	'75016',	'75116',	'78000',	'78100',	'78110',	'78112',	'78117',	'78140',	'78150',	'78160',	'78170',	'78180',	'78210',	'78220',	'78230',	'78260',	'78280',	'78290',	'78330',	'78350',	'78360',	'78380',	'78400',	'78420',	'78430',	'78500',	'78530',	'78560',	'78590',	'78600',	'78620',	'78700',	'78750',	'78800',	'78870',	'78960',	'91300',	'91320',	'91370',	'91400',	'91430',	'91440',	'91570',	'91940',	'92000',	'92100',	'92120',	'92130',	'92140',	'92150',	'92160',	'92170',	'92190',	'92200',	'92210',	'92220',	'92240',	'92250',	'92260',	'92270',	'92290',	'92310',	'92320',	'92330',	'92340',	'92350',	'92360',	'92370',	'92380',	'92400',	'92410',	'92420',	'92430',	'92500',	'92700',	'92800',	'91120',	'91190',	'94230',	'94240',	'94260',	'95100',	'95110',	'95120',	'95130',	'95150',	'95210',	'95220',	'95230',	'95240',	'95250',	'95320',	'95370',	'95390',	'95480',	'95530',	'95550',	'95580',	'95600',	'95680',	'95740',	'95870',	'95880',	'75002',	'75003',	'75011',	'93460')
				  )
GROUP BY
	2,3,4,6,8